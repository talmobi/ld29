<html>
<head>
	<title>Ludum Dare 29</title>
	<style type="text/css">
		body {
			background-color: #222;
			color: #EEE;
		}
	</style>

	<script type="text/javascript" src="http://code.createjs.com/createjs-2013.12.12.min.js"></script>
	<script type="text/javascript" src="stats.js"></script>

</head>
<body onload="init()">
	<h1>Ludum Dare 29</h1>


	<div id="container">
		<canvas id="myCanvas">

		</canvas>
	</div>


	<script type="text/javascript">
		var c = createjs;

		/**
			* STATS
			*/
		var stats = new Stats();
		stats.setMode(1);
		// Align top-left
		stats.domElement.style.position = 'absolute';
		stats.domElement.style.left = '260px';
		stats.domElement.style.top = '10px';
		document.body.appendChild( stats.domElement );

		/**
			* Game variables
			*/
		var size = 384;
		var width = size;
		var height = width * 9 / 16;
		var scale = 2;
		var tileSize = 2;

		var tickCount = 0;

		var stage;
		var fps = 30;

		var GLOBAL = {
		}


		/**
			*	Load assets
			*/
		var map = [];
		var sprSheets = [];
		var sprTiles = [];

		var init = function() {

			var manifest = [
				{src:"assets/level.png", id:"level"},
				{src:"assets/sheet.png", id:"sheet"},
				{src:"assets/tiles.png", id:"tiles"}
			];

			var loader = new c.LoadQueue(false);
			loader.loadManifest(manifest);

			loader.addEventListener("complete", function() {

				/**
					* load tiles sprites
					*/
				var data = {
					images: [loader.getResult("tiles")],
					frames: {width: tileSize, height: tileSize}
				}
				var tileSheet = new c.SpriteSheet(data);
				for (var i = 0; i < tileSheet._frames.length; i++) {
					var spr = new c.Sprite(tileSheet, i);
					//console.log(spr);
					sprTiles.push(spr);
				}

				/**
					* load level data
					* To get the pixel data we need to first
					*	draw the image into a canvas and grab the
					*	imageData (pixels) from the canvas.
					*/
				var imgCanvas = document.createElement('canvas');
				imgCanvas.width = Math.floor(width / 2);
				imgCanvas.height = Math.floor(height / 2);
				var ctx = imgCanvas.getContext('2d');
				var img = loader.getResult("level");

				img.width = imgCanvas.width;
				img.height = imgCanvas.height;

				console.log(img);

				ctx.drawImage(loader.getResult("level"), 0, 0, img.width, img.height);
				document.body.appendChild(imgCanvas); // delete this
				// grab image data from the imgCanvas
				var imgData = ctx.getImageData(0, 0, imgCanvas.width, imgCanvas.height);
				var pixels = imgData.data;

				// loop through the pixels 4BYTE_RGBA
				var count = 0;
				for (var i = 0; i < pixels.length; i += 4) {
					// care only about alpha atm
					var a = pixels[i+3];
					if (a === 0) {
						map.push( {} );
					} else {
						var x = count % imgCanvas.width;
						var y = Math.floor(count / imgCanvas.width);

						if (pixels[i+2] === 255)  { // blue
							map.push( newWaterTile(x * tileSize, y * tileSize) );
						} else
							map.push( newTile(x * tileSize, y * tileSize) );
					}

					count++;
				}

				console.log("count: " + count);

				/**
					* And finally start the game
					*/
				main();
			});
		}


		/**
			*	main
			*/

		var main = function() {
			var canvas = document.getElementById('myCanvas');

			canvas.width = width * scale;
			canvas.height = height * scale;

			/*
			var ctx = canvas.getContext('2d');
			ctx.scale(4,4);
			*/

			stage = new c.Stage(canvas);

			// between pixel fix
			stage.regX = .5;
			stage.regY = .5;

			/**
				* Initialize Map
				*/
			var mapContainer = new c.Container();
			for (var i = 0; i < map.length; i++) {
				var t = map[i];
				if (!t.exists)
					continue; // skip empty tiles
				mapContainer.addChild(t);
			}
			// cache the map (draw time reduced dramatically)
			mapContainer.cache(0, 0, width, height);

			stage.addChild(mapContainer);

			// add a border
			var border = newBox(1, 1, width - 1, height - 1);
			stage.addChild(border);

			stage.scaleX *= scale;
			stage.scaleY *= scale;

			stage.update();

			/**
				* configure Ticker
				*/
			c.Ticker.addEventListener('tick', tick);
			c.Ticker.setFPS(fps);
		}

		/**
			* Game objects creators
			*/
		var newTile = function(x,y) {
			var spr = sprTiles[0].clone();
			spr.exists = true;
			spr.snapToPixel = true;
			spr.x = x;
			spr.y = y;
			spr.w = tileSize;
			spr.h = tileSize;
			return spr;
		}
		var newWaterTile = function(x,y) {
			var spr = sprTiles[4].clone();
			spr.exists = true;
			spr.snapToPixel = true;
			spr.x = x;
			spr.y = y;
			spr.w = tileSize;
			spr.h = tileSize;
			return spr;
		}


		/**
			*	Shape creators
			*/
		var newBox = function(x,y,w,h) {
			var box = new c.Shape();
			box.snapToPixel = true;
			box.graphics.setStrokeStyle(1).beginStroke("white").rect(x, y, w, h);
			return box;
		}


		/**
			*	tick
			*/
		var tick = function() {
			tickCount++;
			stats.begin();

			stage.update();

			stats.end();
		}

	</script>

</body>
</html>